import AsyncStorage from '@react-native-async-storage/async-storage';
import { useFocusEffect } from '@react-navigation/native';
import React, { useCallback, useState } from 'react';
import {
    ActivityIndicator,
    Alert,
    Image,
    Platform,
    ScrollView,
    StyleSheet,
    Text,
    TouchableOpacity,
    View,
} from 'react-native';

function formatCurrency(value) {
  return Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
}

export default function SimulacaoHoje() {
  const [carteira, setCarteira] = useState([]);
  const [saldo, setSaldo] = useState(0);
  const [totalInvestido, setTotalInvestido] = useState(0);
  const [loading, setLoading] = useState(false);

  async function carregar() {
    setLoading(true);
    try {
      const s = await AsyncStorage.getItem('saldo');
      setSaldo(Number(s) || 0);

      const data = await AsyncStorage.getItem('carteira');
      const carteiraSalva = data ? JSON.parse(data) : [];

      // atualizar cotações (opcional)
      const carteiraAtualizada = [];
      for (const item of carteiraSalva) {
        try {
          const response = await fetch(`https://brapi.dev/api/quote/${encodeURIComponent(item.ticker)}?token=3Xgmgj9aPpZTaP2GBajh2z`);
          const json = await response.json();
          const info = json?.results?.[0];
          if (info) {
            carteiraAtualizada.push({
              ...item,
              cotacaoAtual: info.regularMarketPrice ?? item.cotacaoAtual,
              maximoDia: info.regularMarketDayHigh ?? item.maximoDia,
              minimoDia: info.regularMarketDayLow ?? item.minimoDia,
              logoUrl: info.logoUrl || info.logourl || item.logoUrl,
              changePercent: info.regularMarketChangePercent ?? info.changePercent ?? null,
            });
          } else {
            carteiraAtualizada.push(item);
          }
        } catch {
          carteiraAtualizada.push(item);
        }
      }

      setCarteira(carteiraAtualizada);

      let soma = 0;
      carteiraAtualizada.forEach((item) => (soma += Number(item.investimento) || 0));
      setTotalInvestido(soma);
    } catch (error) {
      console.log('Erro ao carregar carteira:', error);
    } finally {
      setLoading(false);
    }
  }

  useFocusEffect(
    useCallback(() => {
      carregar();
    }, [])
  );

  async function executarVenda(index) {
    try {
      const item = carteira[index];
      const valorDevolvido = Number(item.investimento || 0);

      const novaCarteira = carteira.filter((_, i) => i !== index);
      await AsyncStorage.setItem('carteira', JSON.stringify(novaCarteira));

      const novoSaldo = (Number(await AsyncStorage.getItem('saldo')) || 0) + valorDevolvido;
      await AsyncStorage.setItem('saldo', novoSaldo.toString());
      setSaldo(novoSaldo);

      Alert.alert('Sucesso', 'Ação vendida com sucesso!');
      carregar();
    } catch (error) {
      Alert.alert('Erro', 'Não foi possível vender a ação.');
    }
  }

  function venderAcao(index) {
    if (Platform.OS === 'web') {
      const ok = window.confirm('Deseja realmente vender esta ação?');
      if (ok) executarVenda(index);
      return;
    }
    Alert.alert('Confirmar venda', 'Deseja realmente vender esta ação?', [
      { text: 'Cancelar', style: 'cancel' },
      { text: 'Vender', onPress: () => executarVenda(index) },
    ]);
  }

  if (loading) {
    return (
      <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
        <ActivityIndicator size="large" color="#FF9800" />
      </View>
    );
  }